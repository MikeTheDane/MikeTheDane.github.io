
<!DOCTYPE html>
<html lang="en-US">
	<style>
	#animate {
	  width: 24px;
	  height: 24px;
	  border-radius: 12px;
	  background-color: blue;
	  opacity: 0;
	}

	div.smoothie-chart-tooltip {
	  background: #444;
	  padding: 1em;
	  margin-top: 20px;
	  font-family: consolas;
	  color: white;
	  font-size: 16px;
	  pointer-events: none;
	  border-radius: 5px;
	  opacity:  0.8;
	}

	.button {
		  background-color: #888888;
		  border: none;
		  color: white;
		  padding: 15px 32px;
		  text-align: center;
		  text-decoration: none;
		  display: inline-block;
		  font-size: 16px;
		  margin: 4px 2px;
		  border-radius: 5px;
		  cursor: pointer;
		  -webkit-transition-duration: 0.4s; /* Safari */
		  transition-duration: 0.4s;
		  width: 230px;
	}

	.button:hover {
	  box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24),0 17px 50px 0 rgba(0,0,0,0.19);
	}

	.flex-container {
 	   	display: flex;
 	   	background-color: lightgrey;
 	   	padding-top :  3px;
 	   	padding-bottom :  3px;
	}

	.flex-child {
 	   	text-align: left;
 	   	flex: 1;
 	   	/*border: 2px solid yellow;*/
 	   	background-color: white;
 	   	padding:  10px;
 	   	/*border-radius: 8px;*/
	}  

	.flex-child:first-child {
   		
   		
   		margin-right: 3px;
	} 


	</style>
	<head>
		
		<meta charset="UTF-8">
		<title>OB1203 Demo</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="smoothie.js"></script>
		<script>

			var dataChar;
			var device;

			var dataLog ="";
			
			// v1.0 header (just SPO2 and Heart Rate)
			var csvHeader ="Time, SPO2 Level [%], Heart Rate [beats/min]\n";


			// Define the CodeLess UUIDs 
			var POX_SVC_UUID 	="00001822-0000-1000-8000-00805f9b34fb";
			var DATA_CHAR_UUID 	="00002a5f-0000-1000-8000-00805f9b34fb";
			var DISS_SVC_UUID	="0000180a-0000-1000-8000-00805f9b34fb";
			var SW_CHAR_UUID	="00002a28-0000-1000-8000-00805f9b34fb";
			
			// Display text in log field text area 
			function log(text)
			{
				//var textarea = document.getElementById('log');
				//textarea.value += "\n" + text;
				//textarea.scrollTop = textarea.scrollHeight;
				document.getElementById('ble_log').innerHTML = document.getElementById('ble_log').innerHTML + text + '<br/>';
			}

			// Display text in log field text area 
			function datalog(text)
			{
				//var textarea = document.getElementById('log');
				//textarea.value += "\n" + text;
				//textarea.scrollTop = textarea.scrollHeight;
				document.getElementById('data_log').innerHTML = document.getElementById('data_log').innerHTML + text + '<br/>';
			}

			var no_data_yet = true;
			
			// Incoming GATT notification was received
			async function incomingData(event){
				let v= event.target.value;

				display_spo2 = v.getUint8(1);
				display_hr = v.getUint8(3);
				//display_rr = v.getUint8(4);

				if(no_data_yet){
					// We received data for the first time, so render graph
					document.getElementById('chart-area').style = "display:inline;";
					document.getElementById('app-data').style = "display:inline;";
					chart.start();
					no_data_yet = false;
					log("Receiving Data...");
				}
				
				myMove();

				var time = new Date()

				var time2 = time.toLocaleTimeString();

				spo2.append(time,display_spo2);
				hr.append(time,display_hr);
				//rr.append(time,display_rr);

				dataLog = dataLog + time2 + ', ' + display_spo2 + ', ' + display_hr + '\n';

				dataLength = event.target.value.byteLength;
				//log("Reading: SPO2: "+display_spo2+", HR: "+display_hr+", RR: "+display_rr);
				datalog("Reading ["+time2+"]: SPO2: "+display_spo2+", HR: "+display_hr);
			}

			async function onDisconnected()
			{
				log("Bluetooth connection terminated!");
				document.getElementById("connect-button").innerHTML="Connect";
				document.getElementById('ble-status').innerHTML = "Not Connected";
				chart.stop();
			}

			async function bleDisconnect()
			{
				log("Disconnecting");
				if (device.gatt.connected) {
				    device.gatt.disconnect();
				}
				else {
				    log('> Bluetooth Device is already disconnected');
				}
			}

			// Scan, connect and explore CodeLess BLE device
			async function ble_connect() {
				try {
					document.getElementById('ble-status').innerHTML = "Connecting...";
					document.getElementById("connect-button").innerHTML="Connecting...";
					document.getElementById("connect-button").disabled = true;
					// Define a scan filter and prepare for interaction with Codeless Service
					log('Requesting Bluetooth Device...');
					device  = await navigator.bluetooth.requestDevice({
						filters: [{name: 'DLG-OB1203-v10'}],
						optionalServices: [POX_SVC_UUID, DISS_SVC_UUID]
					});	
					device.addEventListener('gattserverdisconnected', onDisconnected);	
					// Connect to device GATT and perform attribute discovery
					server = await device.gatt.connect();

					document.getElementById("connect-button").innerHTML="Disconnect";
					
					document.getElementById('ble-status').innerHTML = "Connected";
					document.getElementById("connect-button").disabled = false;

					const service = await server.getPrimaryService(POX_SVC_UUID);
					dataChar = await service.getCharacteristic(DATA_CHAR_UUID);
					await dataChar.startNotifications();
					dataChar.addEventListener('characteristicvaluechanged', incomingData);

					const dissService =  await server.getPrimaryService(DISS_SVC_UUID);
					const dissChar = await dissService.getCharacteristic(SW_CHAR_UUID);
					let sw_rev = await dissChar.readValue();
					let decoder = new TextDecoder('utf-8');
					log("EVK Software Revision: "+decoder.decode(sw_rev) );

					log('Ready to communicate!\n');
					log('Waiting for valid readings...\n');
				}
				catch(error) {
					log('Failed: ' + error);
					document.getElementById("connect-button").disabled = false;
					document.getElementById('ble-status').innerHTML = "Not Connected";
					document.getElementById("connect-button").innerHTML = "Connect";
				}
			}
				
			// 
		    var spo2 = new TimeSeries();
		    var hr = new TimeSeries();
		    //var rr = new TimeSeries();
		   
		     var chart = new SmoothieChart(
		      		{
			      		millisPerPixel:20,				      	
				      	timestampFormatter:SmoothieChart.timeFormatter,
				      	interpolation:'linear',
				      	maxValue:200,
				      	minValue:0,
				      	tooltip:true,
				      	labels:{fontSize:15,fillStyle:'#000000',precision:0},
				      	grid:{borderVisible:false,millisPerLine:2000,verticalSections:21,fillStyle:'#EEEEEE'}
				      	
		      		}
		      	);

		    function createTimeline() {
		      document.getElementById('chart').width = document.getElementById('stage').clientWidth *0.95;	
		      chart.addTimeSeries(spo2, { 
		      	strokeStyle: 'rgba(0, 0, 255, 1)',
		      	lineWidth: 2 
		      	
		      });
		     
		      chart.addTimeSeries(hr,   {
		     	strokeStyle: 'rgba(255, 0, 0, 1)',
		     	lineWidth: 2 
		     });
		      /*
		      chart.addTimeSeries(rr,   {
		     	strokeStyle: 'rgba(0, 255, 0, 1)',
		     	lineWidth: 2 
		     });
		     */
		     
		     chart.streamTo(document.getElementById("chart"), 1000);
		    }	

		    function adjust_width()
		    {
		    	document.getElementById('chart').width = document.getElementById('stage').clientWidth *0.95;

		    }


		    function myMove() {
			  let id = null;
			  const elem = document.getElementById("animate"); 
			  elem.style.opacity = 1;  
			  let pos = 0;
			  clearInterval(id);
			  id = setInterval(frame, 10);
			  function frame() {
			    if (pos == 100) {
			      clearInterval(id);
			    } else {
			      pos++; 
			      elem.style.opacity= 1-pos/100; 
			    }
			  }
			}

			function save(filename, data) {
			    if(document.getElementById('add-header').checked)
			    	data = csvHeader + data;
			    const blob = new Blob([data], {type: 'text/csv'});
			    if(window.navigator.msSaveOrOpenBlob) {
			        window.navigator.msSaveBlob(blob, filename);
			    }
			    else{
			        const elem = window.document.createElement('a');
			        elem.href = window.URL.createObjectURL(blob);
			        elem.download = filename;        
			        document.body.appendChild(elem);
			        elem.click();        
			        document.body.removeChild(elem);
			    }
			}

			function toggleConnection() {
				if(typeof device !== 'undefined'){
					if (device.gatt.connected) 
						bleDisconnect();
					else
						ble_connect();
				}
				else
					ble_connect();
			}
		</script>

	</head>

	<body onload="createTimeline()" style="background-color: lightgrey;text-align: center" onresize="adjust_width();">

		
		<div id="stage" align='center' style="background-color: white;margin: auto; width: 80%;">
		<br/><h1 align='center'>Renesas OB1203SD-BT2-EVK</h1>
		<a 
			href="https://www.renesas.com/us/en/products/sensor-products/biosensors/ob1203-heart-rate-blood-oxygen-concentration-pulse-oximetry-proximity-light-and-color-sensor" target="_blank">Additional Information</a><br/><br>
		
		<div class="flex-container">
			<div class="flex-child">
				<button id="connect-button" type="button" class="button" onclick="toggleConnection();">
					Connect
				</button>
				<br/>
				Bluetooth Status: <span id="ble-status">Not Connected</span>
				<br/>
				<div id ="animate"></div>
				<!--
				Log:<br/>
				<textarea id="log" rows="10" cols="60" ></textarea>	
				-->
				Bluetooth Log:
				<div id="ble_log" style="border:  2px solid #f0f0f0 ; height:110px;overflow:auto;display:flex; flex-direction:column-reverse;"><br/></div>
			</div>

			<div class="flex-child">
				<div id="app-data" style="display: none;">
				<button id="save-button" type="button" class="button" onclick="save('OB1203.csv', dataLog);">
					Save Data to File
				</button><br/>
				<label for="add-header">
					<input type="checkbox" id="add-header" name="add-header" value="yes" checked>  Add Header to CSV
				</label>

				<br/><br/>

				Data Log:
				<div id="data_log" style="border:  2px solid #f0f0f0 ; height:115px;overflow:auto;display:flex; flex-direction:column-reverse;"><br/></div>	
				</div>
			</div>


		</div>
		<br/><br/>
		<div id="chart-area" style="display:none;text-align: left;"> 
		   	<canvas id="chart" width="1200" height="300"></canvas><br/>
			<svg width="300" height="30">
			<circle cx="20" cy="15" r="10" stroke-width="0" fill="blue" />
			<text fill="#000000" font-size="20"  x="40" y="22">SPO2</text>

			<circle cx="120" cy="15" r="10" stroke-width="0" fill="red" />
			<text fill="#000000" font-size="20"  x="140" y="22">Heart Rate</text>

		</svg>
		
				
		</div>
		
		</div>
	</body>

</html>
