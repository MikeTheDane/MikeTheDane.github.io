
<!DOCTYPE html>
<html lang="en-US">
	<style>
	#animate {
	  width: 24px;
	  height: 24px;
	  border-radius: 12px;
	  background-color: blue;
	  opacity: 0;
	}

	div.smoothie-chart-tooltip {
	  background: #444;
	  padding: 1em;
	  margin-top: 20px;
	  font-family: consolas;
	  color: white;
	  font-size: 16px;
	  pointer-events: none;
	  border-radius: 5px;
	  opacity:  0.8;
	}

	</style>
	<head>
		
		<meta charset="UTF-8">
		<title>OB1203 Demo</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="smoothie.js"></script>
		<script>

			var dataChar;
			var device;

			var dataLog ="";
			
			// v1.0 header (just SPO2 and Heart Rate)
			var csvHeader ="Time, SPO2 Level [%], Heart Rate [beats/min]\n";


			// Define the CodeLess UUIDs 
			var POX_SVC_UUID 	="00001822-0000-1000-8000-00805f9b34fb";
			var DATA_CHAR_UUID 	="00002a5f-0000-1000-8000-00805f9b34fb";
			var DISS_SVC_UUID	="0000180a-0000-1000-8000-00805f9b34fb";
			var SW_CHAR_UUID	="00002a28-0000-1000-8000-00805f9b34fb";
			
			// Display text in log field text area 
			function log(text)
			{
				var textarea = document.getElementById('log');
				textarea.value += "\n" + text;
				textarea.scrollTop = textarea.scrollHeight;
			}

			var no_data_yet = true;
			
			// Incoming GATT notification was received
			async function incomingData(event){
				let v= event.target.value;

				display_spo2 = v.getUint8(1);
				display_hr = v.getUint8(3);
				//display_rr = v.getUint8(4);

				if(no_data_yet){
					// We received data for the first time, so render graph
					document.getElementById('chart-area').style = "display:inline;";
					chart.start();
					no_data_yet = false;
				}
				
				myMove();

				var time = new Date()

				var time2 = time.toLocaleTimeString();

				spo2.append(time,display_spo2);
				hr.append(time,display_hr);
				//rr.append(time,display_rr);

				dataLog = dataLog + time2 + ', ' + display_spo2 + ', ' + display_hr + '\n';

				dataLength = event.target.value.byteLength;
				//log("Reading: SPO2: "+display_spo2+", HR: "+display_hr+", RR: "+display_rr);
				log("Reading ["+time2+"]: SPO2: "+display_spo2+", HR: "+display_hr);
			}

			async function onDisconnected()
			{
				log("Bluetooth connection terminated!");
				chart.stop();
			}

			async function bleDisconnect()
			{
				log("Disconnecting");
				if (device.gatt.connected) {
				    device.gatt.disconnect();
				}
				else {
				    log('> Bluetooth Device is already disconnected');
				}
			}

			// Scan, connect and explore CodeLess BLE device
			async function ble_connect() {
				try {
					// Define a scan filter and prepare for interaction with Codeless Service
					log('Requesting Bluetooth Device...');
					device  = await navigator.bluetooth.requestDevice({
						filters: [{name: 'DLG-OB1203-v10'}],
						optionalServices: [POX_SVC_UUID, DISS_SVC_UUID]
					});	
					device.addEventListener('gattserverdisconnected', onDisconnected);	
					// Connect to device GATT and perform attribute discovery
					server = await device.gatt.connect();
					const service = await server.getPrimaryService(POX_SVC_UUID);
					dataChar = await service.getCharacteristic(DATA_CHAR_UUID);
					await dataChar.startNotifications();
					dataChar.addEventListener('characteristicvaluechanged', incomingData);

					const dissService =  await server.getPrimaryService(DISS_SVC_UUID);
					const dissChar = await dissService.getCharacteristic(SW_CHAR_UUID);
					let sw_rev = await dissChar.readValue();
					let decoder = new TextDecoder('utf-8');
					log("Software Revision: "+decoder.decode(sw_rev) );

					log('Ready to communicate!\n');
					log('Waiting for valid readings...\n');
				}
				catch(error) {
					log('Failed: ' + error);
				}
			}
				
			// 
		    var spo2 = new TimeSeries();
		    var hr = new TimeSeries();
		    //var rr = new TimeSeries();
		   
		     var chart = new SmoothieChart(
		      		{
			      		millisPerPixel:20,				      	
				      	timestampFormatter:SmoothieChart.timeFormatter,
				      	interpolation:'linear',
				      	maxValue:200,
				      	minValue:0,
				      	tooltip:true,
				      	labels:{fontSize:15,fillStyle:'#000000',precision:0},
				      	grid:{borderVisible:false,millisPerLine:2000,verticalSections:21,fillStyle:'#EEEEEE'}
				      	
		      		}
		      	);

		    function createTimeline() {
		     
		      chart.addTimeSeries(spo2, { 
		      	strokeStyle: 'rgba(0, 0, 255, 1)',
		      	lineWidth: 2 
		      	
		      });
		     
		      chart.addTimeSeries(hr,   {
		     	strokeStyle: 'rgba(255, 0, 0, 1)',
		     	lineWidth: 2 
		     });
		      /*
		      chart.addTimeSeries(rr,   {
		     	strokeStyle: 'rgba(0, 255, 0, 1)',
		     	lineWidth: 2 
		     });
		     */
		     
		     chart.streamTo(document.getElementById("chart"), 1000);
		     
		    }	


		    function myMove() {
			  let id = null;
			  const elem = document.getElementById("animate"); 
			  elem.style.opacity = 1;  
			  let pos = 0;
			  clearInterval(id);
			  id = setInterval(frame, 10);
			  function frame() {
			    if (pos == 100) {
			      clearInterval(id);
			    } else {
			      pos++; 
			      elem.style.opacity= 1-pos/100; 
			    }
			  }
			}

			function save(filename, data) {
			    if(document.getElementById('add-header').checked)
			    	data = csvHeader + data;
			    const blob = new Blob([data], {type: 'text/csv'});
			    if(window.navigator.msSaveOrOpenBlob) {
			        window.navigator.msSaveBlob(blob, filename);
			    }
			    else{
			        const elem = window.document.createElement('a');
			        elem.href = window.URL.createObjectURL(blob);
			        elem.download = filename;        
			        document.body.appendChild(elem);
			        elem.click();        
			        document.body.removeChild(elem);
			    }
}

		</script>

	</head>

	<body onload="createTimeline()">

		<h1>PulseOx:</h1>
		<button type="button" onclick="ble_connect()">
			Connect to OB1203
		</button>
		<br/>
		
		<button type="button" onclick="bleDisconnect()">
			Disconnect
		</button>
		<br/>

		<button type="button" onclick="save('OB1203.csv', dataLog);">
			Save
		</button>
		<label for="add-header">
   			<input type="checkbox" id="add-header" name="add-header" value="yes">  Add Header to CSV 
		</label>

		<br/><br/>
		<div id ="animate"></div>
		Log:<br/>
		
		<textarea id="log" rows="20" cols="60" ></textarea>
		<br/><br/>
		<div id="chart-area" style="display:none;"> 
		   	<canvas id="chart" width="1200" height="300"></canvas><br/>
			<svg width="1000" height="30">
			<circle cx="10" cy="15" r="10" stroke-width="0" fill="red" />
			<text fill="#000000" font-size="20"  x="25" y="22">SPO2</text>

			<circle cx="110" cy="15" r="10" stroke-width="0" fill="blue" />
			<text fill="#000000" font-size="20"  x="125" y="22">Heart Rate</text>
		</svg>

			
		</div>
		
	</body>

</html>
