<html>
	<head>
		<title>AT Command Sniffer</title>
		<link rel="icon" type="image/x-icon" href="MTD_favicon.ico">
		<style>
			span{
				font-family: 'Courier New', monospace;
				font-size: 14px;
			}
		</style>
		<script>
			var perspective='a';
			function addZero(x,n) {
				while (x.toString().length < n) {
			    	x = "0" + x;
				}
				return x;
			}

			async function first(s,value){
				value=value.replace(/\n/g,"<LF>");
				if(value!="" || !document.getElementById('filter').checked){
					const stage = document.getElementById("stage");

					if(value == "ATZ" || value.includes("[2J[H")){
						//console.clear();
						stage.innerHTML = "";
					}

					const line = document.createElement("span");
					if(s==perspective){
						console.log("%c=> %s","color:magenta",value);
						const container = document.createElement("text");
						const content = document.createElement("text");
						content.style="color: red; white-space: nowrap;font-weight: bold;margin-left:50px;";
						content.innerText = '=> ' + value +"\n";
						container.innerHTML = "";
						stage.appendChild(container);
						stage.appendChild(content);
						container.scrollIntoView({behavior: "smooth", block: "end", inline: "start"});
					}
					
					else{
						setTimeout(function(){
							console.log("%c\t\t<= %s","color:green",value)
							const container = document.createElement("text");
							const content = document.createElement("text");
							content.style="color: green; white-space: nowrap;font-weight: bold;margin-left:100px;";
							content.innerText = '<= ' + value+"\n";
							container.innerHTML = "";
							stage.appendChild(container);
							stage.appendChild(container);
							stage.appendChild(content);
							container.scrollIntoView({behavior: "smooth", block: "end", inline: "start"});
						},20);
					}
				}
			}

			function time_stamp() {
				var d = new Date();
				var h = addZero(d.getHours(), 2);
				var m = addZero(d.getMinutes(), 2);
				var s = addZero(d.getSeconds(), 2);
				var ms = addZero(d.getMilliseconds(), 3);
				return h + ":" + m + ":" + s + ":" + ms;
			}

			class LineBreakTransformer {
				constructor() {
				  this.chunks = "";
				}

				transform(chunk, controller) {
				    this.chunks += chunk;
				    const lines = this.chunks.split("\r\n");
				    this.chunks = lines.pop();
				    lines.forEach((line) => controller.enqueue(line));
				}

				flush(controller) {
				    controller.enqueue(this.chunks);
				}
			}

			async function serial_connect_a(){			
  				const filters = [
					{ usbVendorId: 0x0403, usbProductId: 0x6001 },
					{ usbVendorId: 0x1366, usbProductId: 0x0105 },
				];

				try{
				port_a = await navigator.serial.requestPort({ filters });
				} catch(error){
					console.log("User failed to select a serial port");
				}
				try{
					await port_a.open({ baudRate: 115200 });
					//console.log(await port_a.getInfo());
					const signals = await port_a.getSignals();
					//console.log("Clear To Send: "+signals.clearToSend);
					if(signals.clearToSend)
						swapPerspective();
				}catch (error) {
					console.log("Serial port failed to open.");
					console.error(error);	
				}

				serial_connect_b();
				while(true){
					const textDecoder = new TextDecoderStream();
					const readableStreamClosed = port_a.readable.pipeTo(textDecoder.writable);
					const reader_a = textDecoder.readable
							.pipeThrough(new TransformStream(new LineBreakTransformer()))
	  						.getReader();
							
					while (true) {
	  					try{
		  					try{
			  					const { value, done } = await reader_a.read();
			  					first('a',value);
			  					if (done) {
			  						// Allow the serial port to be closed later.
			    					reader_a.releaseLock();
			    				
			    					break;
			  					}
		  					}
		  					catch(err) {
							  	break;
							}
						}
						catch(err) {
							  	break;
						}

					}
		  		}
			}

			async function serial_connect_b(){			
  				success = true;
				const filters = [
					{ usbVendorId: 0x0403, usbProductId: 0x6001 },
					{ usbVendorId: 0x1366, usbProductId: 0x0105 },
					{ usbVendorId: 0x0403, usbProductId: 0x6010 },
				];

				try{
					port_b = await navigator.serial.requestPort({ filters });
				} catch(error){
					console.log("User failed to select a serial port");
					success = false;
				}


				if (success){
					try{
						await port_b.open({ baudRate: 115200 });
					}catch (error) {
  					console.log("Serial port failed to open.");
  					console.error(error);
  					
					}

					// Listen to data coming from the serial device.
					while (true) {
						const textDecoder = new TextDecoderStream();
						const readableStreamClosed = port_b.readable.pipeTo(textDecoder.writable);
					
						const reader_b = textDecoder.readable
							.pipeThrough(new TransformStream(new LineBreakTransformer()))
	  						.getReader();
				
						while (true) {
		  					try{
			  					try{
				  					const { value, done } = await reader_b.read();
				  					first('b',value);
				  					if (done) {
				    					// Allow the serial port to be closed later.
				    					reader.releaseLock();
				    				
				    					break;
				  					}
			  					}
			  					catch(err) {
								  	break;
								}
							}
							catch(err) {
							  	break;
							}
			  			}
		  			}
		  		}	
			}

			function swapPerspective(){
				if (perspective=='a')
					perspective='b';
				else
					perspective='a';
			}

			function clear_screen(){
				document.getElementById('stage').innerHTML ="";
			}

			function sizer(){
				const body_size = document.body.clientHeight;
				let top_height = document.getElementById("top").clientHeight;
				document.getElementById("stage").height = (body_size - top_height - 20) + "px";
				console.log("Body : " + body_size);
				console.log("Top  : " + top_height);
				console.log("Stage: " + document.getElementById("stage").height);
				document.getElementById("stage").style.maxHeight =  (body_size - top_height - 30) + "px";
				document.getElementById("stage").style.minHeight =  (body_size - top_height - 30) + "px";
			}

			// Check to see what ports are available when the page loads.
			/*
			document.addEventListener('DOMContentLoaded', async () => {
				  let ports = await navigator.serial.getPorts();
				  console.log(ports);
				  for(let i=0;i<ports.length;i++)
				  	  console.log(ports[i].getInfo());
				  //port_a = ports[0].open({ baudRate: 115200 });
				  // Populate the UI with options for the user to select or
				  // automatically connect to devices.
			});
			*/
		</script>
	</head>
	<body onresize="sizer();">
		
			
		<div id="top">
			<h1>AT Command Sniffer</h1>
			Select two COM ports<br/><br/>
			<button onclick="serial_connect_a();">Connect Ports</button>
			<br/>
			<button onclick="clear_screen();">Clear Screen</button><br/>
			<label for="filter">Filter out empty lines:</label> 
			<input type="checkbox" id="filter" checked/>
			<hr/>
		</div>

		<div id="stage" style="overflow: scroll;"><div>
		<script>sizer();</script>

	</body>
</html>