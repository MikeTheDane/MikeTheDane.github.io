<!DOCTYPE html>
<html lang="en-US">
  
  <head>
    
    <title>Bootloader</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  </head>
<script>

var binfile;
var state = 'IDLE';
var size_msb;
var size_lsb;
var port;
var success = false;
var writer;
var checksum;

function log(text)
{
	var textarea = document.getElementById('log');
	textarea.value += "\n" + text;
	textarea.scrollTop = textarea.scrollHeight;
}

function readFile(input){
	let file = input.files[0];

	//alert(`File name: ${file.name}`); // e.g my.png
	//alert(`Last modified: ${file.lastModified}`); // e.g 1552830408824

	let reader = new FileReader();

	reader.readAsArrayBuffer(file);

	reader.onload = function() {
	//log(reader.result);

    	binfile = new Uint8Array(reader.result);

    	log('Loading file: '+file.name);
    	let file_size = binfile.length;
    	size_msb = (Math.floor(file_size / 256))
    	size_lsb = (file_size % 256)
    	log("file Size: "+file_size)
    	checksum = 0;

	    for(i=0;i<file_size;i++)
    		checksum = checksum ^ binfile[i];
    	log("Calculated Checksum: 0x"+parseInt(checksum,16));
	};

	reader.onerror = function() {
		log(reader.error);
  	};
}


async function write(cmd){
    writer = port.writable.getWriter();
    await writer.write(cmd);
    writer.close();
} 

async function serial_connect(){
	// Prompt user to select any serial port.	
	const filters = [
		{ usbVendorId: 0x0403, usbProductId: 0x6010 },
		{ usbVendorId: 0x1366, usbProductId: 0x0105 },
	];
	port = await navigator.serial.requestPort({ filters });
	//await port.open({ baudRate: 460800 });
	await port.open({ baudRate: 57600 });
}

async function bootload(){
    state = 'IDLE';
    success = false;
    log("Reset target to start upload!");
    // Restart if a UART Break condition is detected (or any other error)
    while(!success){
        const reader = port.readable.getReader(); 
        try{  
                    
            while (!success) {
                const { value, done } = await reader.read();
              	if (done) {
               	   	// Allow the serial port to be closed later.	
                	reader.releaseLock();
                    break;           				
            	}
                
                let b = value[0];
                log('Received Byte: 0x'+parseInt(b,16));

                if(state=='IDLE'){
                	if(b==0x02){
                        
                        log("Sending size");
                        write(new Uint8Array([0x01,size_lsb,size_msb]));  
                        state='SIZE_WAS_SENT';
                      }
                }

                else if(state=='SIZE_WAS_SENT'){
                    if(b==0x06){                        
                        log("Uploading Image")
                        write(binfile);
                        state = 'UPLOAD_WAS_SENT'
                    }
                    else state='IDLE';
                }

                else if(state=='UPLOAD_WAS_SENT'){
                    log("CheckSum: 0x"+parseInt(b,16));  
                      
                    if(checksum == b){
	                    write(new Uint8Array([0x06]));
                        success = true;
                    }
                    else{
    	                write(new Uint8Array([0x15]));
                        log("Upload failed, retrying...");
                        state = 'IDLE';
                    }
                }
            }
        }
        catch(err){
           log(err);
           state = 'IDLE';
        }
      				
    }
    log("DONE!");
}
  

async function send(cmd){
	
	const textEncoder = new TextEncoderStream();
	const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
	const writer = textEncoder.writable.getWriter();
	await writer.write(cmd+"\r");
	writer.close();
}



</script>


<body>
	<button id="comport" class="button button_sh" onclick="serial_connect()">
          Com Port
	</button>
    <input type="file" onchange="readFile(this);"/>
	<button id="comport" class="button button_sh" onclick="bootload()">
          Start
    </button><br/>
    <textarea id="log"  rows="20" cols="60">
    	
    </textarea>
</body>

</html>