<html>
<head>

<script>
  var inboundChar;
  var outboundChar;
  

  
  function log(text)
  {
    var textarea = document.getElementById('log');
    textarea.value += "\n" + text;
    textarea.scrollTop = textarea.scrollHeight;
  }
  
  async function incomingData(event){
    let v = event.target.value;
    
    if( v.getUint8(2)==1){
      
      let x = v.getUint8(5) + 256 * v.getUint8(6);
      if (x>=0x8000)
        x=-(65535-x);
      
      let y = v.getUint8(7) + 256 * v.getUint8(8);
      if (y>=0x8000)
        y=-(65535-y);
      
      let z = v.getUint8(9) + 256 * v.getUint8(10);
      if (z>=0x8000)
        z=-(65535-z);
      
      
      log(x+", "+y+", "+z);
    }
  }
 
  async function doit() {
    try {
      log('Requesting Bluetooth Device...');
      device  = await navigator.bluetooth.requestDevice({
          filters: [{name: 'IoT-585'}],
          optionalServices: ['2ea78970-7d44-44bb-b097-26183f402400']
      });
      log('Connecting to GATT Server...');
      server = await device.gatt.connect();
      log('Getting IoT Sensor Service...');
      const service = await server.getPrimaryService('2ea78970-7d44-44bb-b097-26183f402400');
      log('Getting IoT Command Characteristic...');
      inboundChar = await service.getCharacteristic('2ea78970-7d44-44bb-b097-26183f402409');
    
      log('Getting IoT Reply Characteristic...');
      outboundChar = await service.getCharacteristic('2ea78970-7d44-44bb-b097-26183f40240a');
    
      log('Getting Sensor Data Characteristic...');
      const flowcontrolChar = await service.getCharacteristic('2ea78970-7d44-44bb-b097-26183f402410');
    
      // Subscribe to notifications
      await flowcontrolChar.startNotifications();
      flowcontrolChar.addEventListener('characteristicvaluechanged', incomingData);
    
      log('Ready to communicate');
    } catch(error) {
      log('Failed: ' + error);
    }
}
  
async function writesome() {
  if (!inboundChar) {
    log('GodDang');
    return;
  }
  try{
    log('Sending Command (ATrI)...');
    //let value = Uint8Array.of(0x41,0x54,0x72,0x49,0x00);
    let value = Uint8Array.of(0x01);
    await inboundChar.writeValue(value);
  } catch(error) {
    log('Failed ' + error);
  }
  
}
  
async function sendAT() {
  if (!inboundChar) {
    log('GodDang');
    return;
  }
  var commandToSend = document.getElementById("cmd").value + "\0";  
  try{
    log('Sending Command (' + commandToSend + ')...');
    let encoder = new TextEncoder('utf-8');
    await inboundChar.writeValue(encoder.encode(commandToSend));
  } catch(error) {
    log('Failed ' + error);
  }
  
}
  
</script>  
</head>  

<body>
  <p>IoT Sensor test:</p>

  <button type="button" onclick="doit()">
    Click me to scan for CodeLess BLE devices.
  </button>
  <br/>
  <textarea id="log" rows="25" cols="100" >Log:</textarea>
  <br/>
  <button type="button" onclick="writesome()">
    Start
  </button>
  <br/>
  <input type="text" id="cmd">
  <button type="button" onclick="sendAT()">
    Transmit!
  </button>

</body>
</html>
