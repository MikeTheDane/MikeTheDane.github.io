
var w_gauge_use_html = `<div style="margin: auto;width: 150px;padding:5px;"> 
<svg width="150px" height="150px" version="1.1" viewBox="0 0 93.143 93.143" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs>
  <linearGradient id="linearGradient16115" x1="170.09" x2="71.249" y1="118.97" y2="118.6" gradientUnits="userSpaceOnUse">
   <stop stop-color="#999" offset="0"/>
   <stop stop-color="#4d4d4d" offset="1"/>
  </linearGradient>
 </defs>
 <g transform="translate(-18.677 -72.096)">
  <circle cx="65.248" cy="118.67" r="44.971" fill="#ccc" stroke="#999" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".94472" stroke-width="3.2015"/>
  <circle cx="65.248" cy="118.67" r="42.565" stroke="#333" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".94472" stroke-width="3.2015"/>
  <use width="100%" height="100%" fill="#f2f2f2" xlink:href="#rect15623"/>
  <circle cx="65.248" cy="118.67" r="40.16" fill="url(#linearGradient16115)" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".94472" stroke-width="1.2965"/>
  <g fill="#f2f2f2">
   <rect id="rect15623" x="24.985" y="116.21" width="9.5614" height="4.5634" ry=".68178" fill="#f2f2f2"/>
   <use transform="rotate(45 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <use transform="rotate(90 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <use transform="rotate(135 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <use transform="rotate(180 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <use transform="rotate(225 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <use transform="rotate(-45 65.248 118.69)" width="100%" height="100%" xlink:href="#rect15623"/>
   <rect transform="rotate(22.5)" x="65.022" y="83.809" width="10.394" height="1.7537" ry=".65765"/>
   <rect transform="rotate(67.5)" x="93.945" y="-15.738" width="10.394" height="1.7537" ry=".65765"/>
   <rect transform="rotate(112.5)" x="44.006" y="-106.58" width="10.394" height="1.7537" ry=".65765"/>
   <rect transform="rotate(157.5)" x="-55.541" y="-135.5" width="10.394" height="1.7537" ry=".65765"/>
   <rect transform="rotate(202.5)" x="-146.38" y="-85.562" width="10.394" height="1.7537" ry=".65765"/>
   <rect transform="rotate(-22.5)" x="-25.819" y="133.75" width="10.394" height="1.7537" ry=".65765"/>
  </g>
  <flowRoot transform="scale(.26458)" fill="#000000" font-family="sans-serif" font-size="40px" letter-spacing="0px" word-spacing="0px" style="line-height:1.25" xml:space="preserve"><flowRegion><rect x="80.714" y="638.23" width="148.57" height="41.429"/></flowRegion><flowPara>Energy</flowPara></flowRoot>
  <text x="65.551552" y="146.71658" fill="#ececec" font-family="'Californian FB'" font-size="5.6444px" letter-spacing="0px" stroke="#e6e6e6" stroke-width=".26458" text-align="center" text-anchor="middle" word-spacing="0px" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="gauge_label$widget_index" x="65.551552" y="146.71658">label_$widget_index</tspan><tspan id="units_$widget_index" x="65.551552" y="153.77214">unit_$widget_index</tspan></text>
  <circle cx="65.248" cy="118.67" r="3.9449" fill="#ccc" stroke="#333" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".94472" stroke-width="3.2015"/>
  <g fill="#ececec" font-family="'Californian FB'" font-size="8.4667px" letter-spacing="0px" stroke="#e6e6e6" stroke-width=".26458" word-spacing="0px">
   <text x="36.249977" y="121.4637" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num1_$widget_index" x="36.249977" y="121.4637">number1_$widget_index</tspan></text>
   <text x="65.202957" y="95.288879" text-align="center" text-anchor="middle" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num3_$widget_index" x="65.202957" y="95.288879">number3_$widget_index</tspan></text>
   <text x="44.12133" y="102.924" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num2_$widget_index" x="44.12133" y="102.924">number2_$widget_index</tspan></text>
   <text x="85.849915" y="102.924" text-align="end" text-anchor="end" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num4_$widget_index" x="85.849915" y="102.924">number4_$widget_index</tspan></text>
   <text x="94.269333" y="121.4637" text-align="end" text-anchor="end" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num5_$widget_index" x="94.269333" y="121.4637">number5_$widget_index</tspan></text>
   <text x="44.993683" y="139.51208" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num0_$widget_index" x="44.993683" y="139.51208">0</tspan></text>
   <text x="85.506729" y="139.51208" text-align="end" text-anchor="end" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25" xml:space="preserve"><tspan id="num6_$widget_index" x="85.506729" y="139.51208">number6_$widget_index</tspan></text>
  </g>
  <path id="needle_$widget_index" style="transform-origin:  65.248px 118.67px;" d="m67.35 121.03c-1.2894-0.63792-2.9337-0.66006-4.2886-0.0576-0.23448 0.1042-0.44234 0.16791-0.46189 0.14155-0.01959-0.0266 0.55212-7.3192 1.2704-16.206l1.306-16.158 0.18521 8.59e-4c0.10183 4.96e-4 0.18502 0.03791 0.1848 0.08318-1.62e-4 0.04524 0.50601 7.3477 1.125 16.228 0.61894 8.88 1.1176 16.152 1.1082 16.159-0.0093 8e-3 -0.20253-0.0781-0.4291-0.19018z" fill="#FFFFFF" stroke-width="0"/>
  <circle cx="65.248" cy="118.67" r="3.9449" fill="#d40000" stroke="#333" stroke-linecap="round" stroke-linejoin="round" stroke-opacity=".94472" stroke-width="3.201"/>
 </g>
</svg>
</div>`;

var w_gauge_use_style ='margin:0 auto; display:block;border-radius: 4px; padding-bottom: 10px;width:100%;text-align:center;';

var w_gauge_cfg_defaults = {"id":"","type":"gauge","$value":"0","expanded":true};


function w_gauge_constructor(widget_index)
{
	// Construct an progress bar 
	let s = w_gauge_use_html;
	
	s = s.replace(/\$widget_index/g,widget_index);

	
	s = s.replace("$value",widgets[widget_index].value);

	
    let x = widgets[widget_index].max;
	let a = 0.6;
    let b = 1.2;
    let c = 2.4;
    let d = 3;
    let scale = 0;
    while (x>scale){
      	if(x<=d)
        	scale=d;
    	if(x<=c)
      		scale=c;
    	if(x<=b)
      		scale=b;
    	if(x<=a)
      		scale=a;
    	a=a*10;
    	b=b*10;
    	c=c*10;
    	d=d*10;
    }

    console.log("Scale is "+scale);

    widgets[widget_index].scale = scale;

	// Draw and Redraw
    let delta = widgets[widget_index].scale/6;
    s = s.replace("number1_"+widget_index, delta*1);
    s = s.replace("number2_"+widget_index, delta*2);
    s = s.replace("number3_"+widget_index, delta*3);
    s = s.replace("number4_"+widget_index, delta*4);
    s = s.replace("number5_"+widget_index, delta*5);
    s = s.replace("number6_"+widget_index, delta*6);
//label_$widget_index
    s = s.replace("unit_"+widget_index, widgets[widget_index].unit);
	  s = s.replace("label_"+widget_index, widgets[widget_index].label);
    return s;	

}

function gauge_set_needle(widget_index, parsed_string)
{
	x = parsed_string;
	var innerArrow = document.getElementById("needle_"+widget_index);
    x = x/widgets[widget_index].scale * 270 -135;
	innerArrow.setAttribute("transform", "rotate("+x+")");
}

function w_gauge_cfg(widget_index)
{
	
    let properties = [property_input_filter, _g, property_parser, _g , property_gauge, _g];
	let s = generate_cfg_widget("Gauge Widget", w_gauge_use_style, widget_index, properties);
	
    s = s.replace(/\$value/g,widgets[widget_index].value);
	s = s.replace("$unit",widgets[widget_index].unit);
	s = s.replace("$max",widgets[widget_index].max);
	
	return s;
}

function w_new_gauge_widget(separator,widget_id)
{
	
	let new_widget =  
	{	"type":"gauge",
		"expanded":true ,
		"label":"Label",
		"unit":"Unit",
		"trigger":{"s":0, "filter":"|00"},
		"parser_start":3,
		"parser_count":0,
		"parser_style":0,
		"max":"241",
		"scale":"120"
	};


	new_widget.id = widget_id;
	new_widget.style = w_gauge_use_style;
	widgets.splice(separator,0,new_widget);
}